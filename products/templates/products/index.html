{% extends 'base1.html' %}
{% load django_bootstrap5 %}
{% load humanize %}
{% load static %}

{% block css %}
  <link rel="stylesheet" href="{% static 'products/css/index.css' %}">
{% endblock css %}

<!-- 배너 -->
{% block carousel %}
  <div>
    <div class="main_image visual" style="background: url(https://images.samsung.com/kdp/display/pc/100001610/e43d0030-dea7-4a27-b3fa-8c840648e79e.jpg) center center no-repeat; background-size: cover;">
      {% if category %}
        <p class="main_text">{{ category }}</p>
      {% elif result %}
        <p class="main_text">
          검색결과</p>
      {% elif filter %}
        <p class="main_text">
          검색결과</p>
      {% elif filter == 0 %}
        <p class="main_text">검색 결과가 없습니다.</p>
      {% else %}
        <p class="main_text">전체</p>
      {% endif %}
    </div>
  </div>

{% endblock carousel %}

{% block content %}
  <div class="d-flex align-items-center my-3 justify-content-between">
    <!-- 필터 -->
    <div class="d-flex box-result">
      <p class="detail-search pc-var" style="margin-right: 12px;">상세검색</p>
      <p class="search-result">검색 결과</p>
      {% if category %}
        <p class="now">{{ products_category.count }}개</p>
      {% elif search %}
        <p class="now">{{ search_count }}개</p>
      {% elif filter %}
        <p class="now">{{ filter }}개</p>
      {% elif filter == 0 %}
        <p class="now">{{ filter }}개</p>
      {% else %}
        <p class="now">{{ products.count }}개</p>
      {% endif %}
    </div>

    <!-- 정렬 -->
    <div class="dropdown">
      <button class="btn btns dropdown-toggle" type="button" id="dropdownMenuButton1" data-bs-toggle="dropdown" aria-expanded="false">
        추천순
      </button>
      <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton1">
        <li>
          <a class="dropdown-item" href="#">추천순</a>
        </li>
        <li>
          <a class="dropdown-item" href="#">최신순</a>
        </li>
        <li>
          <a class="dropdown-item" href="#">인기순</a>
        </li>
        <li>
          <a class="dropdown-item" href="#">높은 가격순</a>
        </li>
        <li>
          <a class="dropdown-item" href="#">낮은 가격순</a>
        </li>
      </ul>
    </div>
  </div>
  <hr>

  <div class="main">
    <!-- 사이드바 -->
    <form class="sidebar-wrapper" method="" action="">
      <div>
        <div class="sidebar-0" style="overflow: hidden; height: 45px;">
          <div class="sidebar-brand">
            <div class="main-text">브랜드</div>
            <i class="bi bi-plus plus-click-brand"></i>
          </div>
          <div>
            <div class="sidebar-detail">
              <input type='checkbox' name='brand' value='삼성' onclick='checkOnlyZero(this)'/>
              삼성
            </div>
            <div class="sidebar-detail">
              <input type='checkbox' name='brand' value='LG전자' onclick='checkOnlyZero(this)'/>
              LG전자
            </div>
            <div class="sidebar-detail">
              <input type='checkbox' name='brand' value='APPLE' onclick='checkOnlyZero(this)'/>
              APPLE
            </div>
            <div class="sidebar-detail">
              <input type='checkbox' name='brand' value='ASUS' onclick='checkOnlyZero(this)'/>
              ASUS
            </div>
            <div class="sidebar-detail">
              <input type='checkbox' name='brand' value='레노버' onclick='checkOnlyZero(this)'/>
              레노버
            </div>
            <div class="sidebar-detail">
              <input type='checkbox' name='brand' value='MSI' onclick='checkOnlyZero(this)'/>
              MSI
            </div>
            <div class="sidebar-detail">
              <input type='checkbox' name='brand' value='DELL' onclick='checkOnlyZero(this)'/>
              DELL
            </div>
            <div class="sidebar-detail">
              <input type='checkbox' name='brand' value='한성' onclick='checkOnlyZero(this)'/>
              한성
            </div>
            <div class="sidebar-detail">
              <input type='checkbox' name='brand' value='GIGABYTE' onclick='checkOnlyZero(this)'/>
              GIGABYTE
            </div>
            <div class="sidebar-detail">
              <input type='checkbox' name='brand' value='HP' onclick='checkOnlyZero(this)'/>
              HP
            </div>
          </div>
        </div>
      </div>
      <hr>
      <div>
        <div class="sidebar-1" style="overflow: hidden; height: 45px;">
          <div class="sidebar-display">
            <div class="main-text">화면</div>
            <i class="bi bi-plus plus-click-display"></i>
          </div>
          <div class="sidebar-1-size" style="overflow: hidden; height: 29px;">
            <div class="sidebar-size">
              <div class="main-text">노트북크기</div>
              <i class="bi bi-plus plus-click-size"></i>
            </div>
            <div>
              <div class="sidebar-detail">
                <input type='checkbox' name='size' value='1' onclick='checkOnlyOne(this)'/>
                14인치 이하
              </div>
              <div class="sidebar-detail">
                <input type='checkbox' name='size' value='2' onclick='checkOnlyOne(this)'/>
                15인치~16.2인치
              </div>
              <div class="sidebar-detail">
                <input type='checkbox' name='size' value='3' onclick='checkOnlyOne(this)'/>
                17인치~17.3인치
              </div>
            </div>
          </div>

          <div class="sidebar-1-resolution" style="overflow: hidden; height: 29px;">
            <div class="sidebar-resolution">
              <div class="main-text">해상도</div>
              <i class="bi bi-plus plus-click-resolution"></i>
            </div>
            <div class="sidebar-detail">
              <input type='checkbox' name='resolution' value='FHD' onclick='checkOnlyTwo(this)'/>
              FHD~
            </div>
            <div class="sidebar-detail">
              <input type='checkbox' name='resolution' value='QHD' onclick='checkOnlyTwo(this)'/>
              QHD~
            </div>
            <div class="sidebar-detail">
              <input type='checkbox' name='resolution' value='UHD' onclick='checkOnlyTwo(this)'/>
              ~UHD
            </div>
          </div>
        </div>

      </div>
      <hr>
      <div>
        <div class="sidebar-2" style="overflow: hidden; height: 45px;">
          <div class="sidebar-weight">
            <div class="main-text">무게</div>
            <i class="bi bi-plus plus-click-weight"></i>
          </div>
          <div>
            <div class="sidebar-detail">
              <input type='checkbox' name='weight' value='1' onclick='checkOnlyThree(this)'/>
              1kg 미만
            </div>
            <div class="sidebar-detail">
              <input type='checkbox' name='weight' value='2' onclick='checkOnlyThree(this)'/>
              1kg ~ 1.5kg미만
            </div>
            <div class="sidebar-detail">
              <input type='checkbox' name='weight' value='3' onclick='checkOnlyThree(this)'/>
              1.5kg ~ 2.0kg미만
            </div>
            <div class="sidebar-detail">
              <input type='checkbox' name='weight' value='4' onclick='checkOnlyThree(this)'/>
              2kg 이상
            </div>
          </div>
        </div>
      </div>
      <hr>

      <div>
        <div class="sidebar-3" style="overflow: hidden; height: 45px;">
          <div class="sidebar-processor">
            <div class="main-text">프로세서</div>
            <i class="bi bi-plus plus-click-processor"></i>
          </div>
          <div class="sidebar-3-AMD" style="overflow: hidden; height: 29px;">
            <div class="sidebar-AMD">
              <div>
                <input type='checkbox' name='processor' value='AMD' onclick='checkOnlyFour(this)'/>
                AMD
              </div>
              <i class="bi bi-plus plus-click-AMD"></i>
            </div>

            <div class="sidebar-detail">
              <input type='checkbox' name='processor-nunber' value='4000' onclick='checkOnlyFour(this)'/>
              AMD 4000번대
            </div>
            <div class="sidebar-detail">
              <input type='checkbox' name='processor-nunber' value='5000' onclick='checkOnlyFour(this)'/>
              AMD 5000번대
            </div>
            <div class="sidebar-detail">
              <div class="sidebar-detail">
                <input type='checkbox' name='processor-nunber' value='6000' onclick='checkOnlyFour(this)'/>
                AMD 6000번대
              </div>
            </div>
          </div>
          <div class="sidebar-3-intel" style="overflow: hidden; height: 29px;">
            <div class="sidebar-intel">
              <div>
                <input type='checkbox' name='processor' value='INTEL' onclick='checkOnlyFour(this)'/>
                INTEL
              </div>
              <i class="bi bi-plus plus-click-intel"></i>
            </div>
            <div class="sidebar-detail">
              <input type='checkbox' name='processor-nunber' value='i3' onclick='checkOnlyFour(this)'/>
              i3
            </div>
            <div class="sidebar-detail">
              <input type='checkbox' name='processor-nunber' value='i5' onclick='checkOnlyFour(this)'/>
              i5
            </div>
            <div class="sidebar-detail">
              <input type='checkbox' name='processor-nunber' value='i7' onclick='checkOnlyFour(this)'/>
              i7
            </div>
            <div class="sidebar-detail">
              <input type='checkbox' name='processor-nunber' value='i9' onclick='checkOnlyFour(this)'/>
              i9
            </div>
            <div class="sidebar-detail">
              <input type='checkbox' name='processor-nunber' value='기타' onclick='checkOnlyFour(this)'/>
              기타
            </div>
          </div>
          <div class="sidebar-3-apple" style="overflow: hidden; height: 29px;">
            <div class="sidebar-apple">
              <div>
                <input type='checkbox' name='processor' value='애플' onclick='checkOnlyFour(this)'/>
                애플
              </div>
              <i class="bi bi-plus plus-click-apple"></i>
            </div>
            <div class="sidebar-detail">
              <input type='checkbox' name='processor-nunber' value='M1' onclick='checkOnlyFour(this)'/>
              M1
            </div>
            <div class="sidebar-detail">
              <input type='checkbox' name='processor-nunber' value='M2' onclick='checkOnlyFour(this)'/>
              M2
            </div>
          </div>
        </div>
      </div>
      <hr>

      <div>
        <div class="sidebar-4" style="overflow: hidden; height: 45px;">
          <div class="sidebar-graphic">
            <div class="main-text">그래픽카드</div>
            <i class="bi bi-plus plus-click-graphic"></i>
          </div>
          <div class="sidebar-4-internal">
            <input type='checkbox' name='graphic' value='1' onclick='checkOnlyFive(this)'/>
            내장그래픽
          </div>
          <div class="sidebar-4-external" style="overflow: hidden; height: 29px;">
            <div class="sidebar-external">
              <div>
                <input type='checkbox' name='graphic' value='2' onclick='checkOnlyFive(this)'/>
                외장그래픽
              </div>
              <i class="bi bi-plus plus-click-external"></i>
            </div>
            <div>
              <div class="sidebar-detail">
                <input type='checkbox' name='graphic' value='3' onclick='checkOnlyFive(this)'/>
                인텔
              </div>
              <div class="sidebar-detail">
                <input type='checkbox' name='graphic' value='4' onclick='checkOnlyFive(this)'/>
                AMD
              </div>
              <div class="sidebar-detail">
                <input type='checkbox' name='graphic' value='5' onclick='checkOnlyFive(this)'/>
                엔비디아
              </div>
            </div>
          </div>
        </div>
      </div>
      <hr>

      <div>
        <div class="sidebar-5" style="overflow: hidden; height: 45px;">
          <div class="sidebar-storage">
            <div class="main-text">저장용량</div>
            <i class="bi bi-plus plus-click-storage"></i>
          </div>
          <div class="sidebar-detail">
            <input type='checkbox' name='storage' value='1' onclick='checkOnlySix(this)'/>
            250GB~256GB이하
          </div>
          <div class="sidebar-detail">
            <input type='checkbox' name='storage' value='2' onclick='checkOnlySix(this)'/>
            500GB~512GB이하
          </div>
          <div class="sidebar-detail">
            <input type='checkbox' name='storage' value='3' onclick='checkOnlySix(this)'/>
            1TB이상~2TB미만
          </div>
          <div class="sidebar-detail">
            <input type='checkbox' name='storage' value='4' onclick='checkOnlySix(this)'/>
            2TB이상
          </div>
        </div>
      </div>
      <hr>

      <div>
        <div class="sidebar-6" style="overflow: hidden; height: 45px;">
          <div class="sidebar-price">
            <div class="main-text">가격대</div>
            <i class="bi bi-plus plus-click-price"></i>
          </div>
          <div class="sidebar-detail">
            <input type='checkbox' name='price' value='1' onclick='checkOnlySeven(this)'/>
            50만원 이하
          </div>
          <div class="sidebar-detail">
            <input type='checkbox' name='price' value='2' onclick='checkOnlySeven(this)'/>
            50만원이상~<br>100만원미만
          </div>
          <div class="sidebar-detail">
            <input type='checkbox' name='price' value='3' onclick='checkOnlySeven(this)'/>
            100만원이상~<br>150만원미만
          </div>
          <div class="sidebar-detail">
            <input type='checkbox' name='price' value='4' onclick='checkOnlySeven(this)'/>
            150만원이상~<br>200만원미만
          </div>
          <div class="sidebar-detail">
            <input type='checkbox' name='price' value='5' onclick='checkOnlySeven(this)'/>
            200만원이상
            <br/>
          </div>
        </div>
      </div>
      <hr>
      <input type="checkbox" name='category' value="{{ category }}" checked="true" class="d-none">
      <input type="checkbox" name='search' value="{{ search }}" checked="true" class="d-none">
      <input type="submit" class="form-control form-control-lg" value="조회">
    </form>

    <!-- 제품 목록 -->
    <div class="container">
      <div class="row"></div>
      <div class="row g-3 infinite-container add-event">
        <!-- 1. 네비게이션바로 들어갔을때 -->
        {% if category %}
          {% for product in page_obj %}
            <!-- 카드1 한장 시작 -->
            <div class="hit-product col-12 col-sm-6 col-lg-4 position-relative infinite-item" style="padding:15px;">
              <div class="product-card-body test1">
                <!-- 찜하기 -->
                <div class="position-absolute " style="top:25px; right:20px;">
                  {% if request.user.is_authenticated %}
                    {% if request.user in product.like_product.all %}
                      <i data-product-id="{{ product.pk }}" class="bi bi-bookmark-fill like-btn1"></i>
                    {% else %}
                      <i data-product-id="{{ product.pk }}" class="bi bi-bookmark like-btn1"></i>
                    {% endif %}
                  {% else %}
                    <a href="{% url 'accounts:login' %}">
                      <i class="bi bi-bookmarks"></i>
                    </a>
                  {% endif %}
                </div>
                <div>
                  <img src="{{ product.썸네일 }}" alt="" class="image" style="height: 250px; width: 250px; margin:50px 0 20px 10px;">
                </div>
                <div class="model-text">
                  <h5 class="card-title mt-2">{{ product.모델명 }}</h5>
                  <p class="card-text">
                    <div class="sale-price">
                      <p style="color: gray; margin-bottom: 0;">최저가</p>
                      <p class="class-font">{{ product.가격 | intcomma }}원</p>
                    </div>
                    <hr>
                    <a href="{% url 'products:detail' product.pk %}" class="btn-color">구매하기</a>
                  </div>
                </div>
              </div>
              <!-- 카드1 한장 끝 -->
            {% endfor %}

          {% elif search %}
            <!-- 2. 검색으로 들어갔을때 -->
            {% for product in page_obj %}
              <!-- 카드1 한장 시작 -->
              <div class="hit-product col-12 col-sm-6 col-lg-4 position-relative infinite-item" style="padding:15px;">
                <div class="product-card-body test1">
                  <!-- 찜하기 -->
                  <div class="position-absolute " style="top:25px; right:20px;">
                    {% if request.user.is_authenticated %}
                      {% if request.user in product.like_product.all %}
                        <i data-product-id="{{ product.pk }}" class="bi bi-bookmark-fill like-btn1"></i>
                      {% else %}
                        <i data-product-id="{{ product.pk }}" class="bi bi-bookmark like-btn1"></i>
                      {% endif %}
                    {% else %}
                      <a href="{% url 'accounts:login' %}">
                        <i class="bi bi-bookmarks"></i>
                      </a>
                    {% endif %}
                  </div>
                  <div>
                    <img src="{{ product.썸네일 }}" alt="" class="image" style="height: 250px; width: 250px; margin:50px 0 0 10px;">
                  </div>
                  <div class="model-text">
                    <h5 class="card-title mt-2">{{ product.모델명 }}</h5>
                    <p class="card-text">
                      <div class="sale-price">
                        <p style="color: gray; margin-bottom: 0;">최저가</p>
                        <p class="class-font">{{ product.가격 | intcomma }}원</p>
                      </div>
                      <hr>
                      <a href="{% url 'products:detail' product.pk %}" class="btn-color">구매하기</a>
                    </div>
                  </div>
                </div>
                <!-- 카드1 한장 끝 -->
              {% endfor %}
            {% else %}
              <!-- 3. 그냥 들어갔을때 -->
              {% for product in page_obj %}
                <div class="hit-product col-12 col-sm-6 col-lg-4 position-relative infinite-item" style="padding:15px;">
                  <div class="product-card-body test1 mb-5">
                    <!-- 찜하기 추가 작업 필요 -->
                    <div class="position-absolute " style="top:25px; right:20px;">
                      {% if request.user.is_authenticated %}
                        {% if request.user in product.like_product.all %}
                          <i data-product-id="{{ product.pk }}" class="bi bi-bookmark-fill like-btn1"></i>
                        {% else %}
                          <i data-product-id="{{ product.pk }}" class="bi bi-bookmark like-btn1"></i>
                        {% endif %}
                      {% else %}
                        <a href="{% url 'accounts:login' %}">
                          <i class="bi bi-bookmarks"></i>
                        </a>
                      {% endif %}
                    </div>
                    <div>
                      <img src="{{ product.썸네일 }}" alt="" class="image" style="height: 250px; width: 250px; margin:50px 0 0 10px;">
                    </div>
                    <div class="model-text">
                      <h5 class="card-title mt-2">{{ product.모델명 }}</h5>
                      <div class="sale-price">
                        <p style="color: gray; margin-bottom: 0;">최저가</p>
                        <p class="class-font">{{ product.가격 | intcomma }}원</p>
                      </div>
                      <hr>
                      <a href="{% url 'products:detail' product.pk %}" class="btn-color">구매하기</a>
                    </div>
                  </div>
                </div>
                <!-- 카드1 한장 끝 -->
              {% endfor %}
            {% endif %}
          </div>
          <div class="d-flex position-absolute">
            <button class="btn btn-primary loading">
              <span class="spinner-border spinner-border-sm"></span>
              로딩중입니다.
            </button>
          </div>

          <div class="row">
            <div class="col-3">
              {% if search %}
                {% if page_obj.has_next %}
                  <a class="infinite-more-link" href="?search={{ search }}&page={{ page_obj.next_page_number }}&brand={{ brand }}&price={{ price }}&weight={{ weight }}&processor={{ processor }}&processor_number={{ processor_number }}&storage={{ storage }}&graphic={{ graphic }}&resolution={{ resolution }}&size={{ size }}">next</a>
                {% endif %}
              {% elif category %}
                {% if page_obj.has_next %}
                  <a class="infinite-more-link" href="?category={{ category }}&page={{ page_obj.next_page_number }}&brand={{ brand }}&price={{ price }}&weight={{ weight }}&processor={{ processor }}&processor_number={{ processor_number }}&storage={{ storage }}&graphic={{ graphic }}&resolution={{ resolution }}&size={{ size }}">next</a>
                {% endif %}
              {% else %}
                {% if page_obj.has_next %}
                  <a class="infinite-more-link" href="?page={{ page_obj.next_page_number }}&brand={{ brand }}&price={{ price }}&weight={{ weight }}&processor={{ processor }}&processor_number={{ processor_number }}&storage={{ storage }}&graphic={{ graphic }}&resolution={{ resolution }}&size={{ size }}">next</a>
                {% endif %}
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
  {% endblock content %}

  <!-- 자바스크립트 -->
  {% block js %}
    <script src="{% static 'products/js/index.js' %}"></script>
    <script src="{% static 'js/jquery.waypoints.min.js' %}"></script>
    <script src="{% static 'js/infinite.min.js' %}"></script>

    <!-- 무한스크롤 -->
    <script>
      var infinite = new Waypoint.Infinite({
        element: $('.infinite-container')[0],
        offset: 'bottom-in-view',
        onBeforePageLoad: function () {
          $('.loading').show();
        },
        onAfterPageLoad: function () {
          $('.loading').hide();
        }
      })
    </script>

    <script>
      function checkOnlyZero(element) {
        const checkboxes = document.getElementsByName("brand");
        checkboxes.forEach((cb) => {
          cb.checked = false;
        })
        element.checked = true;
      }

      function checkOnlyOne(element) {
        const checkboxes = document.getElementsByName("size");
        checkboxes.forEach((cb) => {
          cb.checked = false;
        })
        element.checked = true;
      }

      function checkOnlyTwo(element) {
        const checkboxes = document.getElementsByName("resolution");
        checkboxes.forEach((cb) => {
          cb.checked = false;
        })
        element.checked = true;
      }

      function checkOnlyThree(element) {
        const checkboxes = document.getElementsByName("weight");
        checkboxes.forEach((cb) => {
          cb.checked = false;
        })
        element.checked = true;
      }

      function checkOnlyFour(element) {
        const checkboxes = document.getElementsByName("processor");
        checkboxes.forEach((cb) => {
          cb.checked = false;
        })
        element.checked = true;
      }

      function checkOnlyFive(element) {
        const checkboxes = document.getElementsByName("graphic");
        checkboxes.forEach((cb) => {
          cb.checked = false;
        })
        element.checked = true;
      }

      function checkOnlySix(element) {
        const checkboxes = document.getElementsByName("storage");
        checkboxes.forEach((cb) => {
          cb.checked = false;
        })
        element.checked = true;
      }

      function checkOnlySeven(element) {
        const checkboxes = document.getElementsByName("price");
        checkboxes.forEach((cb) => {
          cb.checked = false;
        })
        element.checked = true;
      }
    </script>

    <!-- 북마크 비동기 -->
    <script>
      $(document).on("click", ".like-btn1", function (e) {
        const productId = e.target.dataset.productId;
        e.preventDefault()
        axios({method: "get", url: `/products/like/${productId}`}).then(response => {
          if (response.data.isLiked === true) {
            e
              .target
              .classList
              .add('bi-bookmarks-fill')
            e
              .target
              .classList
              .remove('bi-bookmarks')
          } else {
            e
              .target
              .classList
              .add('bi-bookmarks')
            e
              .target
              .classList
              .remove('bi-bookmarks-fill')
          }
        })
      })
    </script>

    <script>
      window.onkeydown = function () {
        var kcode = event.keyCode;
        if (kcode == 116) {
          history.replaceState({}, null, location.pathname);
        }
      }
    </script>

  {% endblock js %}
